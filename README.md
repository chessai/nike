# nike
Installing nixos with `justdoit`.
@cleverca22 came up with all of this, wrote the justdoit.nix file, and showed me how to use it.
This repo is just a condensed version with some documentation showing others how to use it.

## The Goal
- Install NixOS with `justdoit`, a convenience script that takes care of a lot
  of nitty-gritty system setup for you, especially if you are using zfs.

## The steps, at a high level
- Define a NixOS configuration that can be built into a bootable NixOS ramdisk for any server with a linux kernel that has kexec enabled
- Define a NixOS configuration that gets placed onto the target host, which gets used by `nixos-install` (invoked by `justdoit`)
- Deploy the NixOS ramdisk to the server
- Boot from that ramdisk
- Run `justdoit`
- Profit

## What you will need
- A source machine running Linux/MacOS with Nix installed. You will need to enable flakes and nix-command.
- A target machine running the Linux kernel with kexec enabled.

### Configure the NixOS ramdisk
Edit configuration.nix to your liking. Necessary things:
1. Imports (netboot-minimal.nix, kexec.nix, justdoit.nix)
2. Networking. You can use `wpa\_supplicant` or network manager.
3. authorized ssh keys for the root user. This is so you can ssh to the machine
   after booting the NixOS ramdisk.
4. Configure `kexec.justdoit`. See justdoit.nix for available options.
   This will require knowing things about the target system, most of which
   you can find out via `fdisk -l`.

See the example provided configuration.nix for reference.

### Configure the target config
Edit target-config.nix to your liking. This will be the resulting configuration
on the new system after `justdoit` has finished and NixOS has been forcibly
installed on the target. You will probably want networking and ssh keys on this,
but it's not necessary unless you don't have physical access to the machine.
You can use an existing NixOS configuration for this (e.g. your NixOS config).
Know that it should import `./hardware-configuration.nix` and `./generated.nix`,
but these are files that are generated by `justdoit`, and not things you should
provide. See the example provided target-config.nix for reference.

### Build the kexec tarball
```bash
$ nix build '.#nixosConfigurations.nike.config.system.build.kexec_tarball' -j4
```

### Deploy the tarball to the target machine and install NixOS
```
TODO
```
